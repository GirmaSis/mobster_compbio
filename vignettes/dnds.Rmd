---
title: "dN/dS statistics for mobster fits"
author: "Giulio Caravagna"
date: "January 2020"
institute: "Institute for Cancer Research"
email: "giulio.caravagna@icr.ac.uk"
output: rmarkdown::github_document
vignette: >
  %\VignetteIndexEntry{"dN/dS statistics for mobster fits"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r, message=FALSE, warning=F}
library(mobster)
library(tidyr)
library(dplyr)
```

This vignette describes how to compute dN/dS values from the clusters of a MOBSTER model.

## Computing dnds values

dN/dS values are provided by  the [dndscv](https://github.com/im3sanger/dndscv/) R package, discussed in (Martincorena, et al. *"Universal patterns of selection in cancer and somatic tissues"*, Cell 171.5 (2017): 1029-1041; [PMID 29056346](https://www.ncbi.nlm.nih.gov/pubmed/29056346)).

To compute dN/dS values annotated mutations must have genomic coordinates: chromosome location `chrom`, position `from`, reference alleles `alt` and `ref`. We show this analysis with the fits for the `PD4120a` breast cancer sample dataset.

```{r, fig.width=5, fig.height=4}
data('PD4120a_breast_sample', package = 'mobster')

# Print and plot the model
print(PD4120a_breast_sample$best)
plot(PD4120a_breast_sample$best)
```

We compute the values using the clustering assignments from the best fit.

```{r, fig.width=2.5, fig.height=5}
clusters = Clusters(PD4120a_breast_sample$best)
pio::pioDisp(clusters)
```

The available clusters are `C1`, `C2`, `C3` and `Tail`; `C1` is the clonal cluster and 
`C2` and `C3` are subclones. The statistics can  be computed for a custom grouping of the actual clusters. If `mapping  = c(`C1` = 'G1', `C2` = 'G1', `C3` = 'G1', `Tail` = 'G2')`, 
then mutations from clusters `C1`, `C2` and `C3` are pooled into group `G1`. By default, with `mapping = NULL`, each cluster is a group. 

We run the `dnds` analysis using the default gene list (`gene_list = NULL`) available in `dndscv`.

```{r, fig.width=3, fig.height=3, warning=FALSE}
# Run with this grouping and default gene list
dnds_stats = dnds(
  clusters,
  mapping = c(`C1` = 'Non-tail', `C2` = 'Non-tail', `C3` = 'Non-tail', `Tail` = 'Tail'),
  gene_list = NULL
)
```

The tables returned returned by `dndscv` and a `ggplot` plot are returned. In the tables, column `dnds_group` labels the group.
```{r, fig.width=9, fig.height=3, warning=FALSE}
# Summary statistics
print(dnds_stats$dnds_summary)

# Table observation countns
print(dnds_stats$dndscv_table)

# Plot
print(dnds_stats$plot)
```

The default plot contains results obtained from all substitution models available in `dndscv`. Specific models can be required using the parameters of the `dnds` function.

## Using custom genes lists

A custom list of genes can be supplied in the call to `dnds()` as the variable `genes_list`.

MOBSTER provides 4 lists of interests for this type of computation:

* a list of driver genes compiled in `Martincorena et al. Cell 171.5 (2017): 1029-1041.`;
* a list of driver genes compiled in `Tarabichi, et al. Nature Genetics 50.12 (2018): 1630.`;
* a list of essential genes compiled in `Wang et al. Science 350.6264 (2015): 1096-1101.`;
* a list of essential genes compiled in `Bloomen et al. Science 350.6264 (2015): 1092-1096.`.

which are available to load.

```{r}
# Load the list
data('cancer_genes_dnds', package = 'mobster')

# Each sublist is a list 
print(lapply(cancer_genes_dnds, head))
```

A custom gene list can be used. Beware that with data of a single patient there are might be few, or no substitutions to compute dnds values
```{r, eval=FALSE}
# Not run here
dnds_stats = dnds(
  clusters,
  mapping = c(`C1` = 'Non-tail', `C2` = 'Non-tail', `C3` = 'Non-tail', `Tail` = 'Tail'),
  gene_list = cancer_genes_dnds$Martincorena_drivers
)
```

## Pooling data from multiple patients

The input format of the `dnds` function allows to pool data from several fits at once. We pool data from the real datasets available in the package.

```{r}
# Lung and breast samples
data('LU4_lung_sample', package = 'mobster')
data('LUFF76_lung_sample', package = 'mobster')
data('PD4120a_breast_sample', package = 'mobster')
```

We pool the data selecting the required columns.

```{r, fig.width=9, fig.height=3, warning=FALSE}
dnds_multi = dnds(
  rbind(
    Clusters(LU4_lung_sample$best) %>% select(chr, from, ref, alt, cluster) %>% mutate(sample = 'LU4'),
    Clusters(LUFF76_lung_sample$best) %>% select(chr, from, ref, alt, cluster) %>% mutate(sample = 'LUFF76'),
    Clusters(PD4120a_breast_sample$best) %>% select(chr, from, ref, alt, cluster) %>% mutate(sample = 'PD4120a')
  ),
  mapping = c(`C1` = 'Non-tail', `C2` = 'Non-tail', `C3` = 'Non-tail', `Tail` = 'Tail'),
)

print(dnds_multi$plot)
```

